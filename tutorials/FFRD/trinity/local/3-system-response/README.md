## System Response Curves
The system response curves are sampled at any breachable structure in the watershed (dams and levees). These curves are sampled to provide a breach trigger elevation for each breachable strucutre for each event. The curves are sampled based on the block (or synthetic year) random number for the fragility curves plugin.
The curves are stored in a json file as a model file. This file is not generated by the previous steps it is a model input file (much like a RAS p01.hdf) that is a requirement. In a real project these are made by the levee and dam SME's and provided to the team in the modeling directory.

## Fragility Curve All Samples Action documentation
https://github.com/USACE-Cloud-Compute/fragility-curve-plugin/blob/main/internal/actions/all-samples.md

### Plugin Manifest
The plugin manifest for the fragility curve is functionally identical to the seed generator plugin and is documented [here](../1-blockfile-generation/README.md#plugin-manifest).  The tutorial common folder includes a plugin manifest for the fragility curve plugin.

### Compute Manifest
The compute manifest to generate system response curves using the fragilty curve plugin is:
```json
{
  "manifest_name": "fragilitycurves-trinity",  //user defined.  Set this to any name you like.
  "plugin_definition": "FFRD-FRAGILITYCURVES-TRINITY", //this must match the name from the fragility-curve-plugin-manifest
  "stores": [
    {
      "name": "FFRD", //name of the store.  This is defined by the plugin author.
      "store_type": "S3", //type of store.  S3 for this tutorial
      "profile": "FFRD", //the profile prefix that will be used to extract the environment variable configuration.
      "params": {
        "root": "model-library/ffrd-trinity" //the location on the store that all references will start from
      }
    }
  ],
  "inputs": {
    "payload_attributes": { //effectively "global" level attributes for the plugin.  Any action can access these attributes
      "scenario": "conformance",
      "outputroot": "simulations"
    }
  },
  "actions": [
    {
      "name": "all-samples", //the name of the action to run.  Actions are defined by the plugin author
      "type": "all-samples", //this is a legacy field. for now, set it to the same value as the name.
      "description": "create failure_elevations", //a user defined description for the run
      "attributes": { //private attributes for the action
        "seeds_format": false,
        "elevations_format": false
      },
      "inputs": [
        {
          "name": "fragilitycurve", //the name of the input data source.  This is defined by the plugin author
          "paths": {

            //the path to the output location relative to the store root.
            //this path introduces a concept of compute manifest substitution rules.
            //on initialization, a plugin job will resolve the substitution variables and perform the substitution.
            //for example, when a plugin runs this path, the scenario attribute will be substituted and the path will
            //resolve to: "conformance/system-response/conformance_system_response_curves.json"
            "default": "{ATTR::scenario}/system-response/{ATTR::scenario}_system_response_curves.json"
          
          },
          "store_name": "FFRD" //the store that will be used to write the output
        },
        {
          "name": "seeds",
          "paths": {

            //this path will resolve to "conformance/simulations/seeds.json" at runtime
            "default": "{ATTR::scenario}/{ATTR::outputroot}/seeds.json" 
          
          },
          "store_name": "FFRD"
        }
      ],
      "outputs": [ 
        {
          "name": "failure_elevations", //the name of the output data source.  This is defined by the plugin author
          "paths": {

            //failure elevations will have multiple outputs that can be defined within a single output configuration
            //the "event" path introduces a "VAR" substitution keyword.  This form of substitution is reserved for use by the
            //plugin author and will not be substituted on initialization.
            //therefore, on initialization "event" will resolve to: conformance/simulations/event-dat/{VAR::eventnumber}/system-response/failure_elevations.json"
            //the plugin author is responsible for handling the {VAR::eventnumber} substitution in their code
            "default": "{ATTR::scenario}/{ATTR::outputroot}/system-response/failure_elevations.csv",
            "event": "{ATTR::scenario}/{ATTR::outputroot}/event-data/{VAR::eventnumber}/system-response/failure_elevations.json"
          },
          "store_name": "FFRD"
        }
      ]
    }
  ]
}

```

## parametrization for the tutorial
| Attribute | Description | Value |
|-----------|----------|-------------|
| `seeds_format` | When true seeds are read from the eventstore  | false
| `elevations_format` | When true elevations are written to the eventstore | true

## required inputs

| Datasource Name | Path Key | Path Value (resolved from substitution) |
|-----------|----------|-------------|
| `fragilitycurve` | default  | conformance/system-response/conformance_system_response_curves.json |
| `seeds` | default | conformance/simulations/seeds.json |


### Compute file
The compute file effectively links the plugin manifest, compute manifest and compute provider together.

```json
{
    "name": "System Response Generation Test",
    "provider": { //this block defined the compute provider
        "type": "docker", //we will use the local docker provider
        "concurrency": 1, //we do not need to run multiple concurrent jobs, so this is set to 1
        "queue": "docker-local" //the local docker provider has a single internal queue defined as "docker-local"
    },
    "plugins": [
        "../common/fragilitycurves-plugin-manifest.json" //reference to the plugin manifest
    ],
    "event": {
        "compute-manifests": [
            "compute-manifest.json" //reference to the compute manifest
        ]
    },
    
    //local docker has a simple in-memory credential management system.
    //it maps environment variables to secretsmanager key names.  
    //for example, in this configuration the env variable AWS_ACCESS_KEY_ID is mapped to a credentail manager variable of "secretsmanager:AWS_ACCESS_KEY_ID::".  subsequently, in the plugin manifest configuration, the credential manager value of "secretsmanager:AWS_ACCESS_KEY_ID::" is mapped into the running plugin as FFRD_AWS_ACCESS_KEY_ID
    "secrets-manager": {
        "type": "env",
        "secrets": {
            "secretsmanager:AWS_ACCESS_KEY_ID::": "AWS_ACCESS_KEY_ID",
            "secretsmanager:AWS_SECRET_ACCESS_KEY::": "AWS_SECRET_ACCESS_KEY"
        }
    }
}
```

### Running the plugin
to run the plugin perform the following steps
  1) make sure you have set up your local stores and copied the starting set of trinity files into your ffrd store
  2) create an environment file to run local docker compute.  The file must have the following elements:
     ```bash
        CC_AWS_ACCESS_KEY_ID={Minio AccessKey}
        CC_AWS_SECRET_ACCESS_KEY={Minio SecretKey}
        CC_AWS_DEFAULT_REGION=us-east-1
        CC_AWS_S3_BUCKET={cc store bucket name}
        CC_AWS_ENDPOINT={minio local endpoint.  Typically "http://localhost:9000"}
        AWS_ACCESS_KEY_ID={Minio AccessKey}
        AWS_SECRET_ACCESS_KEY={Minio SecretKey}
        CC_ROOT=cc_store
     ```
  3) open a command line into the `3-system-response` directory
  4) run the following command:
  ```bash
  >> cccli -e={path to your environment file} run
  ```
  
  
  for a successful run, you should see output similar to this:
  ```txt
    Compute Identifier: f9f222a3-fcbb-4108-9b9b-73c7e0668843
    2025/12/19 14:06:00 SUBMITTED JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c
    2025/12/19 14:06:00 RUNNING JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c
    STARTING MONITOR FOR: 1c2512abbfab6be8db2b7a68f64660396c58bce2db44a8f4606215e8a86cda23
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.287604636Z SDK 2025/12/19 19:06:00 WARN Response has no supported checksum. Not validating response payload.
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.287794969Z {"time":"2025-12-19T19:06:00.287713344Z","level":"INFO","msg":"Fragility Curves","version":"v1.0.5-0-ge9b9b7a","build-date":"2025-11-10T18:34:57Z"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.287816011Z {"time":"2025-12-19T19:06:00.287728344Z","level":"INFO","msg":"Running all-samples"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.291569927Z SDK 2025/12/19 19:06:00 WARN Response has no supported checksum. Not validating response payload.
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.323839219Z conformance/simulations/event-data/{VAR::eventnumber}/system-response/failure_elevations.json
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.323865927Z {"time":"2025-12-19T19:06:00.323752511Z","level":"ACTION","msg":"Progress","percent":0,"action":"all-samples"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.339508011Z {"time":"2025-12-19T19:06:00.339401677Z","level":"ACTION","msg":"Progress","percent":10,"action":"all-samples"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.354228219Z {"time":"2025-12-19T19:06:00.354145386Z","level":"ACTION","msg":"Progress","percent":20,"action":"all-samples"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.369064386Z {"time":"2025-12-19T19:06:00.368953094Z","level":"ACTION","msg":"Progress","percent":30,"action":"all-samples"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.385171969Z {"time":"2025-12-19T19:06:00.385070136Z","level":"ACTION","msg":"Progress","percent":40,"action":"all-samples"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.399877177Z {"time":"2025-12-19T19:06:00.399770261Z","level":"ACTION","msg":"Progress","percent":50,"action":"all-samples"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.414523177Z {"time":"2025-12-19T19:06:00.414424802Z","level":"ACTION","msg":"Progress","percent":60,"action":"all-samples"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.432164219Z {"time":"2025-12-19T19:06:00.432047219Z","level":"ACTION","msg":"Progress","percent":70,"action":"all-samples"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.448649386Z {"time":"2025-12-19T19:06:00.448552219Z","level":"ACTION","msg":"Progress","percent":80,"action":"all-samples"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.463584844Z {"time":"2025-12-19T19:06:00.463485261Z","level":"ACTION","msg":"Progress","percent":90,"action":"all-samples"}
    JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c: 2025-12-19T19:06:00.484420927Z {"time":"2025-12-19T19:06:00.484288927Z","level":"INFO","msg":"Completed all-samples"}
    2025/12/19 14:06:00 FINISHED JOB: b9a3faf3-03f5-4eb6-a4b2-944e6e6ab85c
  ```